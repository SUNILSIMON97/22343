<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡Æ®‡Æ£‡Øç‡Æ™‡Æ©‡Øç AI - Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile.css') }}">
    <style>
        :root {
            --bg-0: #050505;
            --bg-1: #0f0f0f;
            --gold: #c7a661;
            --gold-soft: rgba(199, 166, 97, 0.18);
            --text-1: #f2f2f2;
            --text-2: #b8b8b8;
            --bubble: #121212;
        }

        body {
            margin: 0;
            font-family: "Noto Sans Tamil", "Poppins", "Segoe UI", sans-serif;
            background: radial-gradient(1200px 600px at 50% -200px, #1c1c1c 0%, #0b0b0b 40%, #050505 100%);
            color: var(--text-1);
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .chat-header {
            background: #0b0b0b;
            color: var(--text-1);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(199, 166, 97, 0.35);
            box-shadow: 0 1px 0 rgba(199, 166, 97, 0.2);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .nanban-avatar {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: linear-gradient(145deg, #1a1a1a, #101010);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: var(--gold);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
        }
        
        .nanban-info h2 {
            margin: 0;
            font-size: 20px;
        }
        
        .nanban-status {
            font-size: 12px;
            color: var(--text-2);
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .icon-button {
            background: #121212;
            border: 1px solid rgba(255,255,255,0.08);
            color: var(--text-1);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-button:hover {
            border-color: rgba(199, 166, 97, 0.45);
            color: var(--gold);
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: transparent;
        }
        
        .message {
            display: flex;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 16px;
            position: relative;
        }
        
        .message.nanban .message-bubble {
            background: var(--bubble);
            border: 1px solid rgba(255,255,255,0.06);
            box-shadow: 0 2px 10px rgba(0,0,0,0.35);
        }
        
        .message.user .message-bubble {
            background: linear-gradient(180deg, #d0b36f, #b8944c);
            color: #0b0b0b;
        }
        
        .message-text {
            font-size: 16px;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        
        .message-audio {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .play-button {
            background: #121212;
            color: var(--gold);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .typing-indicator {
            display: none;
            padding: 12px 18px;
            background: var(--bubble);
            border-radius: 16px;
            width: fit-content;
            border: 1px solid rgba(255,255,255,0.06);
        }
        
        .typing-indicator.active {
            display: flex;
            gap: 5px;
        }
        
        .dot {
            width: 8px;
            height: 8px;
            background: var(--gold);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        .input-container {
            background: #0b0b0b;
            padding: 15px 20px;
            border-top: 1px solid rgba(255,255,255,0.06);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toggle-button {
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.08);
            background: #121212;
            color: var(--text-1);
            cursor: pointer;
        }


        .suggestions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .suggestion-btn {
            background: #121212;
            border: 1px solid rgba(255,255,255,0.08);
            padding: 6px 10px;
            border-radius: 14px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-1);
        }

        .checkin-bar {
            background: #0b0b0b;
            border-bottom: 1px solid rgba(199, 166, 97, 0.25);
            padding: 12px 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .checkin-text {
            font-size: 13px;
            color: var(--text-2);
        }

        .mood-chip {
            background: #121212;
            border: 1px solid rgba(255,255,255,0.08);
            padding: 6px 10px;
            border-radius: 999px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-1);
        }

        .checkin-note {
            flex: 1;
            min-width: 160px;
            padding: 6px 10px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.08);
            background: #121212;
            color: var(--text-1);
            font-size: 12px;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 18px;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 999px;
            font-size: 16px;
            outline: none;
            background: #121212;
            color: var(--text-1);
            transition: border-color 0.2s ease;
        }
        
        .message-input:focus {
            border-color: rgba(199, 166, 97, 0.55);
        }
        
        .send-button {
            background: linear-gradient(180deg, #d0b36f, #b8944c);
            color: #0b0b0b;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-button:hover {
            transform: translateY(-1px);
        }
        
        .send-button:disabled {
            background: #333;
            color: #777;
            cursor: not-allowed;
            transform: none;
        }
        
        @media (max-width: 768px) {
            .message-bubble {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <div class="header-left">
                <div class="nanban-avatar" aria-hidden="true">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                        <path d="M12 2.5l1.6 4.2 4.2 1.6-4.2 1.6-1.6 4.2-1.6-4.2-4.2-1.6 4.2-1.6L12 2.5z" stroke="#c7a661" stroke-width="1.6" fill="none"/>
                    </svg>
                </div>
                <div class="nanban-info">
                    <h2>‡Æ®‡Æ£‡Øç‡Æ™‡Æ©‡Øç AI</h2>
                    <div class="nanban-status" id="statusText">‡ÆÜ‡Æ©‡Øç‡Æ≤‡Øà‡Æ©‡Øç ‚Ä¢ {{ slang }} ‚Ä¢ {{ persona }}</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="icon-button" onclick="toggleVoice()" id="voiceToggle" title="Toggle Voice" aria-label="Toggle Voice">
                    <svg viewBox="0 0 24 24" width="18" height="18" stroke="#c7a661" fill="none" stroke-width="1.7">
                        <path d="M4 9h4l5-4v14l-5-4H4z"></path>
                        <path d="M16 8c1.5 1.5 1.5 6 0 7.5"></path>
                        <path d="M18.5 6c2.5 2.5 2.5 10 0 12.5"></path>
                    </svg>
                </button>
                <button class="icon-button" onclick="clearChat()" title="Clear Chat" aria-label="Clear Chat">
                    <svg viewBox="0 0 24 24" width="18" height="18" stroke="#c7a661" fill="none" stroke-width="1.7">
                        <path d="M4 7h16"></path>
                        <path d="M9 7V5h6v2"></path>
                        <path d="M7 7l1 12h8l1-12"></path>
                    </svg>
                </button>
                <button class="icon-button" onclick="goToSettings()" title="Settings" aria-label="Settings">
                    <svg viewBox="0 0 24 24" width="18" height="18" stroke="#c7a661" fill="none" stroke-width="1.7">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19 12a7 7 0 0 0-.1-1l2-1.5-2-3-2.2 1a7 7 0 0 0-1.7-1l-.3-2.4h-3.5l-.3 2.4a7 7 0 0 0-1.7 1l-2.2-1-2 3 2 1.5a7 7 0 0 0 0 2L3.7 14l2 3 2.2-1a7 7 0 0 0 1.7 1l.3 2.4h3.5l.3-2.4a7 7 0 0 0 1.7-1l2.2 1 2-3-2-1.5c.1-.3.1-.6.1-1z"></path>
                    </svg>
                </button>
            </div>
        </div>


        <!-- Daily check-in -->
        <div class="checkin-bar" id="checkinBar" style="display:none;">
            <span class="checkin-text" id="checkinText">‡Æá‡Æ©‡Øç‡Æ©‡Øà‡Æï‡Øç‡Æï‡ØÅ ‡Æ®‡Ææ‡Æ≥‡Øç ‡Æé‡Æ™‡Øç‡Æ™‡Æü‡Æø ‡Æ™‡Øã‡Æö‡Øç‡Æö‡ØÅ?</span>
            <button class="mood-chip" onclick="sendCheckin('‡Æ®‡Æ≤‡Øç‡Æ≤‡Ææ')">‡Æ®‡Æ≤‡Øç‡Æ≤‡Ææ</button>
            <button class="mood-chip" onclick="sendCheckin('‡Æö‡Æ∞‡Æø')">‡Æö‡Æ∞‡Æø</button>
            <button class="mood-chip" onclick="sendCheckin('‡ÆÆ‡Øã‡Æö‡ÆÆ‡Øç')">‡ÆÆ‡Øã‡Æö‡ÆÆ‡Øç</button>
            <input class="checkin-note" id="checkinNote" placeholder="‡Æí‡Æ∞‡ØÅ ‡Æµ‡Æ∞‡Æø‡ÆØ‡Æø‡Æ≤‡Øç ‡Æö‡Øä‡Æ≤‡Øç‡Æ≤‡ØÅ...">
        </div>

        <!-- Controls -->
        <div style="padding: 10px 20px; background: #0b0b0b; border-bottom: 1px solid rgba(255,255,255,0.06);"></div>
        
        <!-- Messages -->
        <div class="messages-container" id="messagesContainer">
            <!-- Welcome message -->
            <div class="message nanban">
                <div class="message-bubble">
                    <div class="message-text" id="welcomeMessage">‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç! ‡Æ®‡Ææ‡Æ©‡Øç ‡Æá‡Æô‡Øç‡Æï ‡Æ§‡Ææ‡Æ©‡Øç ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Øá‡Æ©‡Øç. ‡Æé‡Æ™‡Øç‡Æ™‡Æü‡Æø ‡Æâ‡Æ§‡Æµ‡Æ≤‡Ææ‡ÆÆ‡Øç? üòä</div>
                </div>
            </div>
            
            <!-- Typing indicator -->
            <div class="typing-indicator" id="typingIndicator">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <span style="margin-left:8px; font-size:12px; color:#b8b8b8;">‡Æ®‡Æ£‡Øç‡Æ™‡Æ©‡Øç ‡Æé‡Æ¥‡ØÅ‡Æ§‡Æø‡Æï‡Øç‡Æï‡Æø‡Æü‡Øç‡Æü‡ØÅ ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Ææ‡Æ©‡Øç‚Ä¶</span>
            </div>
        </div>
        
        <!-- Input -->
        <div class="input-container">
            <input
                type="file"
                id="imageInput"
                accept="image/*"
                capture="environment"
                style="display: none;"
                onchange="handleImageUpload(event)"
            />
            <button class="icon-button" onclick="document.getElementById('imageInput').click()" title="Upload Image" aria-label="Upload Image">
                <svg viewBox="0 0 24 24" width="18" height="18" stroke="#c7a661" fill="none" stroke-width="1.7">
                    <rect x="4" y="7" width="16" height="12" rx="2"></rect>
                    <circle cx="12" cy="13" r="3"></circle>
                    <path d="M8 7l1.5-2h5L16 7"></path>
                </svg>
            </button>
            <input 
                type="text" 
                class="message-input" 
                id="messageInput" 
                placeholder="‡Æâ‡Æô‡Øç‡Æï message ‡Æé‡Æ¥‡ØÅ‡Æ§‡ØÅ‡Æô‡Øç‡Æï..."
                onkeypress="handleKeyPress(event)"
            />
            <button class="send-button" id="sendButton" onclick="sendMessage()" aria-label="Send">
                <svg viewBox="0 0 24 24" width="18" height="18" stroke="#0b0b0b" fill="none" stroke-width="2">
                    <path d="M4 12l16-7-4 14-4-5-8-2z"></path>
                </svg>
            </button>
        </div>
        <div id="imagePreview" style="display: none; padding: 10px 20px; background: #0b0b0b;">
            <img id="previewImg" style="max-width: 200px; max-height: 200px; border-radius: 10px;">
            <button class="icon-button" onclick="removeImage()" title="Remove Image" aria-label="Remove Image">
                <svg viewBox="0 0 24 24" width="16" height="16" stroke="#c7a661" fill="none" stroke-width="2">
                    <path d="M6 6l12 12M18 6l-12 12"></path>
                </svg>
            </button>
        </div>
    </div>
    
    <script>
        let voiceEnabled = false;
        let currentAudio = null;
        let uploadedImageData = null;
        let uploadedImageMime = null;
        let memoryConsent = null;
        let currentMood = 'CHILL';
        let replyMode = 'quick';
        
        // Auto-scroll to bottom
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }
        
        // Add message to chat
        function addMessage(text, isUser, audioUrl = null) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'nanban'}`;
            
            let audioHTML = '';
            if (audioUrl && !isUser) {
                audioHTML = `
                    <div class="message-audio">
                        <button class="play-button" onclick="playAudio('${audioUrl}')">‚ñ∂</button>
                        <span style="font-size: 12px; opacity: 0.7;">Voice message</span>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div class="message-text">${escapeHtml(text)}</div>
                    ${audioHTML}
                </div>
            `;

            if (!isUser) {
                const chips = document.createElement('div');
                chips.className = 'suggestions';
                ['‡Æö‡Æ∞‡Æø', '‡Æá‡Æ©‡Øç‡Æ©‡ØÅ‡ÆÆ‡Øç ‡Æö‡Øä‡Æ≤‡Øç‡Æ≤‡ØÅ', '‡Æï‡Øä‡Æû‡Øç‡Æö‡ÆÆ‡Øç ‡Æµ‡Æø‡Æ≥‡Æï‡Øç‡Æï‡ØÅ', '‡Æ∞‡Øä‡ÆÆ‡Øç‡Æ™ ‡Æö‡Æø‡Æï‡Øç‡Æï‡Æ≤‡Øç'].forEach((s) => {
                    const btn = document.createElement('button');
                    btn.className = 'suggestion-btn';
                    btn.textContent = s;
                    btn.addEventListener('click', () => {
                        const input = document.getElementById('messageInput');
                        input.value = s;
                        sendMessage();
                    });
                    chips.appendChild(btn);
                });
                messageDiv.querySelector('.message-bubble').appendChild(chips);
            }
            
            container.insertBefore(messageDiv, document.getElementById('typingIndicator'));
            scrollToBottom();
        }

        function addSuggestions(suggestions) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message nanban';

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';

            const text = document.createElement('div');
            text.className = 'message-text';
            text.textContent = 'Nanban busy... Try these?';

            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.className = 'suggestions';

            suggestions.forEach((s) => {
                const btn = document.createElement('button');
                btn.className = 'suggestion-btn';
                btn.textContent = s;
                btn.addEventListener('click', () => {
                    const input = document.getElementById('messageInput');
                    input.value = s;
                    sendMessage();
                });
                suggestionsDiv.appendChild(btn);
            });

            bubble.appendChild(text);
            bubble.appendChild(suggestionsDiv);
            messageDiv.appendChild(bubble);
            container.insertBefore(messageDiv, document.getElementById('typingIndicator'));
            scrollToBottom();
        }
        
        // Play audio
        function playAudio(audioUrl) {
            if (currentAudio) {
                currentAudio.pause();
            }
            
            currentAudio = new Audio(audioUrl);
            currentAudio.play();
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Send message
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('imagePreview').style.display = 'flex';
                uploadedImageData = e.target.result.split(',')[1];
                uploadedImageMime = file.type || 'image/jpeg';
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            document.getElementById('imagePreview').style.display = 'none';
            uploadedImageData = null;
            uploadedImageMime = null;
            document.getElementById('imageInput').value = '';
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message && !uploadedImageData) return;
            
            // Disable input while sending
            input.disabled = true;
            document.getElementById('sendButton').disabled = true;
            
            // Add user message to chat
            if (message) {
                addMessage(message, true);
            }
            input.value = '';
            
            // Show typing indicator
            document.getElementById('typingIndicator').classList.add('active');
            
            try {
                // Send to backend
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        image_data: uploadedImageData,
                        image_mime: uploadedImageMime,
                        mood: currentMood,
                        reply_mode: replyMode
                    })
                });
                
                const data = await response.json();
                
                // Hide typing indicator
                document.getElementById('typingIndicator').classList.remove('active');
                
                if (data.success) {
                    // Add AI response
                    addMessage(data.response, false, data.audio_url);

                    if (data.suggestions && data.suggestions.length) {
                        addSuggestions(data.suggestions);
                    }
                    
                    // Auto-play voice if enabled
                    if (voiceEnabled && data.audio_url) {
                        setTimeout(() => playAudio(data.audio_url), 300);
                    }
                } else {
                    addMessage('‡ÆÆ‡Æ©‡Øç‡Æ©‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç, technical issue ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æ§‡ØÅ. ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.', false);
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('typingIndicator').classList.remove('active');
                addMessage('Connection error. Please check your internet.', false);
            }
            
            // Re-enable input
            input.disabled = false;
            document.getElementById('sendButton').disabled = false;
            input.focus();
            removeImage();
        }
        
        // Handle Enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        // Toggle voice
        function setVoiceIcon() {
            const button = document.getElementById('voiceToggle');
            if (voiceEnabled) {
                button.innerHTML = `
                    <svg viewBox="0 0 24 24" width="18" height="18" stroke="#c7a661" fill="none" stroke-width="1.7">
                        <path d="M4 9h4l5-4v14l-5-4H4z"></path>
                        <path d="M16 8c1.5 1.5 1.5 6 0 7.5"></path>
                        <path d="M18.5 6c2.5 2.5 2.5 10 0 12.5"></path>
                    </svg>
                `;
            } else {
                button.innerHTML = `
                    <svg viewBox="0 0 24 24" width="18" height="18" stroke="#c7a661" fill="none" stroke-width="1.7">
                        <path d="M4 9h4l5-4v14l-5-4H4z"></path>
                        <path d="M19 5l-6 6"></path>
                        <path d="M13 11l6 6"></path>
                    </svg>
                `;
            }
        }

        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            setVoiceIcon();
        }

        async function loadMemoryStatus() {
            try {
                const res = await fetch('/api/memory/status');
                const data = await res.json();
                memoryConsent = data.consent;
                currentMood = data.mood || 'CHILL';
                replyMode = data.reply_mode || 'quick';
            } catch (e) {
                console.error('Memory status error', e);
            }
        }

        async function loadCheckinStatus() {
            try {
                const res = await fetch('/api/checkin/status');
                const data = await res.json();
                if (!data.done) {
                    const hour = new Date().getHours();
                    if (hour >= 19) {
                        document.getElementById('checkinText').textContent = '‡Æá‡Æ©‡Øç‡Æ©‡Øà‡Æï‡Øç‡Æï‡ØÅ ‡Æ®‡Æ≤‡Øç‡Æ≤ ‡Æµ‡Æø‡Æ∑‡ÆØ‡ÆÆ‡Øç ‡Æí‡Æ©‡Øç‡Æ©‡ØÅ ‡Æö‡Øä‡Æ≤‡Øç‡Æ≤‡ØÅ?';
                    }
                    document.getElementById('checkinBar').style.display = 'flex';
                }
            } catch (e) {
                console.error('Checkin status error', e);
            }
        }

        async function sendCheckin(mood) {
            const note = document.getElementById('checkinNote').value.trim();
            await fetch('/api/checkin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mood: mood, note: note })
            });
            document.getElementById('checkinBar').style.display = 'none';
            addMessage(`‡Æö‡ØÇ‡Æ™‡Øç‡Æ™‡Æ∞‡Øç, ‡Æá‡Æ©‡Øç‡Æ±‡ØÅ mood: ${mood}.`, false);
        }

        async function persistMemoryPrefs() {
            if (memoryConsent === null) return;
            await fetch('/api/memory/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    consent: memoryConsent,
                    facts: '',
                    mood: currentMood,
                    reply_mode: replyMode
                })
            });
        }

        // Clear chat
        async function clearChat() {
            if (!confirm('Clear all messages?')) return;
            
            try {
                await fetch('/api/clear-history', {
                    method: 'POST'
                });
                
                // Clear UI
                const container = document.getElementById('messagesContainer');
                while (container.firstChild) {
                    container.removeChild(container.firstChild);
                }
                
                // Re-add welcome message and typing indicator
                container.innerHTML = `
                    <div class="message nanban">
                        <div class="message-bubble">
                            <div class="message-text">‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç! ‡Æ®‡Ææ‡Æ©‡Øç ‡Æâ‡Æô‡Øç‡Æï ‡Æ®‡Æ£‡Øç‡Æ™‡Æ©‡Øç. ‡Æé‡Æ™‡Øç‡Æ™‡Æü‡Æø ‡Æâ‡Æ§‡Æµ‡Æ≤‡Ææ‡ÆÆ‡Øç? üòä</div>
                        </div>
                    </div>
                    <div class="typing-indicator" id="typingIndicator">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                `;
            } catch (error) {
                console.error('Error clearing chat:', error);
            }
        }
        
        // Go to settings
        function goToSettings() {
            window.location.href = '/setup';
        }
        
        // Focus input on load
        window.onload = () => {
            document.getElementById('messageInput').focus();
            setVoiceIcon();
            loadMemoryStatus();
            loadCheckinStatus();
        };
    </script>
</body>
</html>
